# 🖥️ Kubernetes Worker Node Setup Guide (Ubuntu 22.04)

## 1. System Preparation

### 1.1 Update System

```bash
sudo apt update && sudo apt upgrade -y
```

### 1.2 Disable Swap

Kubernetes requires **swap off**:

```bash
sudo swapoff -a
```

Make it permanent:

```bash
sudo sed -i '/ swap / s/^\(.*\)$/#\1/' /etc/fstab
```

Verify:

```bash
free -h
```

👉 Swap should show `0B`.

---

## 2. Kernel Modules & sysctl

### 2.1 Load required modules

```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter
```

### 2.2 Enable sysctl params for Kubernetes networking

```bash
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
```

Check:

```bash
sysctl net.bridge.bridge-nf-call-iptables net.ipv4.ip_forward
```

---

## 3. Install Container Runtime (containerd)

### 3.1 Install dependencies

```bash
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
```

### 3.2 Install containerd

```bash
sudo apt install -y containerd
```

### 3.3 Configure containerd

```bash
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
```

Edit config:

```bash
sudo nano /etc/containerd/config.toml
```

Find:

```
SystemdCgroup = false
```

Change to:

```
SystemdCgroup = true
```

Restart:

```bash
sudo systemctl restart containerd
sudo systemctl enable containerd
```

---

## 4. Install Kubernetes Tools

### 4.1 Add Kubernetes apt repo

```bash
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | \
  sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | \
  sudo tee /etc/apt/sources.list.d/kubernetes.list
```

### 4.2 Install kubelet, kubeadm, kubectl

```bash
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

Enable services:

```bash
sudo systemctl enable --now kubelet
```

---

## 5. Join the Cluster

On your **control-plane node**, get the join command:

```bash
kubeadm token create --print-join-command
```

You’ll get something like:

```bash
kubeadm join 192.168.100.44:6443 --token abcd12.efgh34ijkl56mnop \
    --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxx
```

👉 Run this exact command on your **worker node**.

---

## 6. Verify the Node

On the **control-plane node**:

```bash
kubectl get nodes -o wide
```

Expected output:

```
NAME      STATUS   ROLES    AGE   VERSION   INTERNAL-IP      OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
2080-2    Ready    control-plane   12m   v1.30.14   192.168.100.44   Ubuntu 22.04.5 LTS   6.8.0-79-generic   containerd://1.7.27
pc2       Ready    <none>          9m    v1.30.14   192.168.100.77   Ubuntu 22.04.4 LTS   6.5.0-1025-oem     containerd://1.7.27
```

---

## 7. Troubleshooting Worker Node Issues

### 7.1 Node stuck in `NotReady`

* Check CNI (Flannel, Calico, etc.)

  ```bash
  kubectl get pods -n kube-flannel -o wide
  ```
* If pods are `CrashLoopBackOff`, delete them → they’ll restart:

  ```bash
  kubectl delete pod -n kube-flannel -l app=flannel
  ```

### 7.2 Logs

```bash
sudo journalctl -u kubelet -f
```

### 7.3 Reset Node

If join fails:

```bash
sudo kubeadm reset -f
sudo systemctl restart kubelet
sudo systemctl restart containerd
```

Then re-run the `kubeadm join` command.

---

✅ Now your **worker node is fully configured** and can schedule workloads.

